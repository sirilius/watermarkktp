let startX,startY,val="",textValue="",textObj={},selectedText=0,angle=0,isDownloadable=!1,src="";const img=new Image;img.addEventListener("load",(function(){const e=ctx.canvas,t=e.width/img.width,a=e.height/img.height,n=Math.min(t,a),i=(e.width-img.width*n)/2,l=(e.height-img.height*n)/2;ctx.clearRect(0,0,e.width,e.height),ctx.drawImage(img,0,0,img.width,img.height,i,l,img.width*n,img.height*n),draggable()}));const elementText=document.querySelector("#text"),inputFile=document.querySelector("#inputFile"),elementFont=document.querySelector("#select-font"),selectPosition=document.querySelector("#select-position"),selectFontSize=document.querySelector("#select-font-size"),draggableFile=document.querySelector(".draggable-file"),elementColor=document.querySelector("#colorPicker"),downloadAnchor=document.querySelector("#download"),elementOpacity=document.querySelector("#opacity"),elementInputOpacity=document.querySelector("#opacity-input"),labelFile=document.querySelector(".label-file"),elementRotate=document.querySelector("#rotate"),elementInputRotate=document.querySelector("#rotate-input"),closeBtn=document.querySelector(".close-btn"),resetAnchor=document.querySelector("#reset"),navBar=document.querySelector(".nav-bar"),popUp=document.querySelector("#pop-up"),canvas=document.querySelector("#canvas"),ctx=canvas.getContext("2d");let canvasOffset=canvas.getBoundingClientRect(),offsetX=canvasOffset.left,offsetY=canvasOffset.top,scrollX=canvas.scrollLeft,scrollY=canvas.scrollTop,reader=new FileReader;reader.addEventListener("load",(function(e){img.src=e.target.result,src=e.target.result,canvas.classList.add("show"),isDownloadable=!0})),window.addEventListener("resize",(()=>{canvasOffset=canvas.getBoundingClientRect(),offsetX=canvasOffset.left,offsetY=canvasOffset.top,scrollX=canvas.scrollLeft,scrollY=canvas.scrollTop})),window.addEventListener("click",(function(e){e.target===popUp&&(popUp.style.display="none")})),window.addEventListener("DOMContentLoaded",(()=>{inputFile.addEventListener("change",handleImage,!1);[elementColor,elementFont].forEach((e=>e.addEventListener("input",(()=>draggable()))));[selectFontSize,elementOpacity].forEach((e=>e.addEventListener("input",(()=>draggable(img))))),elementText.addEventListener("input",(function(){textValue=elementText.value,draggable()})),elementRotate.addEventListener("input",(function(){let e=elementRotate.value;document.getElementById("rotate-input").value=e,draggable(img)})),elementInputRotate.addEventListener("input",(function(){let e=elementInputRotate.value;document.getElementById("rotate").value=e,draggable(img)})),elementOpacity.addEventListener("input",(function(){let e=elementOpacity.value;document.getElementById("opacity-input").value=e,draggable(img)})),elementInputOpacity.addEventListener("input",(function(){let e=elementInputOpacity.value;document.getElementById("opacity").value=e,draggable(img)})),selectPosition.addEventListener("input",(function(){switch(selectPosition.value){case"top":textObj.y=90,textObj.x=400;break;case"top-left":textObj.y=90,textObj.x=100;break;case"top-right":textObj.y=90,textObj.x=700;break;case"center":textObj.y=300,textObj.x=400;break;case"center-left":textObj.y=300,textObj.x=100;break;case"center-right":textObj.y=300,textObj.x=700;break;case"bottom":textObj.y=500,textObj.x=400;break;case"bottom-left":textObj.y=500,textObj.x=100;break;case"bottom-right":textObj.y=500,textObj.x=700}draggable(img)})),canvas.addEventListener("click",(function(e){selectedText=1,mouseXY(e),setTimeout((()=>{selectedText=0}),1)})),canvas.addEventListener("pointerdown",mouseDown,!1),canvas.addEventListener("pointermove",mouseXY,!1),canvas.addEventListener("pointerup",mouseXY,!1),canvas.addEventListener("mousedown",mouseDown,!1),canvas.addEventListener("mousemove",mouseXY,!1),document.body.addEventListener("mouseup",mouseUp,!1),navBar.addEventListener("click",(function(){popUp.style.display="flex"})),closeBtn.addEventListener("click",(function(){popUp.style.display="none"})),downloadAnchor.addEventListener("click",(function(){if(!isDownloadable)return alert("Gambar belum diunggah, silakan unggah gambar terlebih dahulu!");if(isWMEmpty())return alert("Watermark belum ditentukan!");const e=canvas.toDataURL("image/png");downloadAnchor.setAttribute("href",e)})),resetAnchor.addEventListener("click",(function(){elementText.value="",dispatchEvent(elementText,"input"),elementRotate.value="0",elementOpacity.value="0.5",document.querySelector("#rotate-val").value="0Â°",document.querySelector("#colorPicker").value="#000000",selectPosition.value="top",dispatchEvent(selectPosition,"input"),elementFont.value="times New Roman",selectFontSize.value="20"})),inputFile.addEventListener("change",(function(){const e=this.value.split("\\").pop();inputFile.nextElementSibling.innerHTML=`<span class="truncate-text">${e}</span>`,""===document.querySelector(".truncate-text").innerHTML&&(labelFile.innerHTML='<i class="fas fa-arrow-circle-up" style="margin-right: 8px"></i> Pilih Gambar'),draggableFile.style.display="none"})),draggableFile.addEventListener("dragover",dragOverHandler,!1),draggableFile.addEventListener("drop",dropHandler,!1)}));const isWMEmpty=()=>""===elementText.value.replace(/^\s+|\s+$/g,"");function mouseUp(){canvas.classList.add("grab"),canvas.classList.remove("grabbing"),selectedText=0,mouseXY()}function mouseDown(){canvas.classList.add("grabbing"),canvas.classList.remove("grab"),selectedText=1,mouseXY()}function mouseXY(e){try{e.preventDefault(),canvasX=e.pageX-canvas.offsetLeft,canvasY=e.pageY-canvas.offsetTop,changePosXY(canvasX,canvasY)}catch(e){}}function changePosXY(e,t){selectedText&&(textObj.x=e,textObj.y=t,draggable())}function draggable(e,t=0,a=0){let n=t>0?t:canvas.height/3,i=a>0?a:canvas.width/2;const l=elementColor.value,c=elementFont.value,o=selectFontSize.value;textObj.x&&textObj.y&&(n=textObj.y,i=textObj.x);let r={text:textValue,x:i,y:n};angle=elementRotate.value;const s=elementOpacity.value,d=`rgba(${parseInt(l.slice(-6,-4),16)},\n    ${parseInt(l.slice(-4,-2),16)},\n    ${parseInt(l.slice(-2),16)},\n    ${s})`,u=ctx.measureText(textValue),g=Math.ceil(u.actualBoundingBoxAscent+u.actualBoundingBoxDescent);ctx.font=`${o}px ${c}`,ctx.fillStyle=d,ctx.textAlign="center",r.width=Math.ceil(ctx.measureText(textValue).width),r.height=g,textObj=r,theimg()}function theimg(){const e=ctx.canvas,t=e.width/img.width,a=e.height/img.height,n=Math.min(t,a),i=(e.width-img.width*n)/2,l=(e.height-img.height*n)/2;ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(img,0,0,img.width,img.height,i,l,img.width*n,img.height*n),ctx.save();const c=textObj;ctx.textAlign="center",ctx.translate(c.x,c.y),ctx.rotate(angle*(Math.PI/180));const o=c.text.split("\n"),r=selectFontSize.value;o.forEach(((e,t)=>ctx.fillText(e,0,r*(t+1)))),ctx.restore()}function validateImage(){var e=inputFile.value.toLowerCase();return regex=new RegExp("(.*?).(jpg|jpeg|png)$"),!!regex.test(e)||(alert("Format gambar yang Anda masukan salah"),inputFile.value="",!1)}function handleImage(e){validateImage(e.target.files[0])&&reader.readAsDataURL(e.target.files[0])}function dispatchEvent(e,t){if("createEvent"in document){const a=document.createEvent("HTMLEvents");a.initEvent(t,!1,!0),e.dispatchEvent(a)}else e.fireEvent(t)}function dropHandler(e){if(e.preventDefault(),e.dataTransfer.items){for(let t=0;t<e.dataTransfer.items.length;t++)if("file"===e.dataTransfer.items[t].kind){const a=e.dataTransfer.items[t].getAsFile();a.type.includes("image/")&&(reader.readAsDataURL(a),draggableFile.style.display="none")}}else for(let t=0;t<e.dataTransfer.files.length;t++)reader.readAsDataURL(e.dataTransfer.files[t])}function dragOverHandler(e){e.preventDefault()}const year=document.querySelector(".copyright .year");year.innerText=(new Date).getFullYear();
